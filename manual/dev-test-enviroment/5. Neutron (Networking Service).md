# Prerequisites
# Run on Controller Node
1. To create the database, complete these steps:
* Use the database access client to connect to the database server as the root user:
```shell
mysql
```
* Create the neutron database:
```shell
MariaDB [(none)]> CREATE DATABASE neutron;
```
* Grant proper access to the neutron database, replacing NEUTRON_DBPASS with a suitable password:
```shell
MariaDB [(none)]> GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'Passw0rd';
MariaDB [(none)]> GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'Passw0rd';
```
```shell
MariaDB [(none)]> exit
```
2. Source the admin credentials to gain access to admin-only CLI commands:
```shell
. admin-openrc
```
3. To create the service credentials, complete these steps:
* Create the neutron user:
```shell
openstack user create --domain default --password-prompt neutron
```
```shell
root@controller:~# openstack user create --domain default --password-prompt neutron
User Password:
Repeat User Password:
+---------------------+----------------------------------+
| Field               | Value                            |
+---------------------+----------------------------------+
| domain_id           | default                          |
| enabled             | True                             |
| id                  | 8604d1b46ba44c6a82d82a4f7cbdaf1a |
| name                | neutron                          |
| options             | {}                               |
| password_expires_at | None                             |
+---------------------+----------------------------------+
```
* Add the admin role to the neutron user:
```shell
openstack role add --project service --user neutron admin
```
* Create the neutron service entity:
```shell
openstack service create --name neutron --description "OpenStack Networking" network
```
```shell
root@controller:~# openstack service create --name neutron --description "OpenStack Networking" network
+-------------+----------------------------------+
| Field       | Value                            |
+-------------+----------------------------------+
| description | OpenStack Networking             |
| enabled     | True                             |
| id          | 2e25614cc66d4069a9123af5d25084ae |
| name        | neutron                          |
| type        | network                          |
+-------------+----------------------------------+
```
4. Create the Networking service API endpoints:
```shell
root@controller:~# openstack endpoint create --region RegionOne network public http://controller:9696
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 0e1a70b8552e4a03bc6952f7a1122d2b |
| interface    | public                           |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 2e25614cc66d4069a9123af5d25084ae |
| service_name | neutron                          |
| service_type | network                          |
| url          | http://controller:9696           |
+--------------+----------------------------------+
root@controller:~# openstack endpoint create --region RegionOne network internal http://controller:9696
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 4ee2cac7b3584c1b91d1397cc371a53a |
| interface    | internal                         |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 2e25614cc66d4069a9123af5d25084ae |
| service_name | neutron                          |
| service_type | network                          |
| url          | http://controller:9696           |
+--------------+----------------------------------+
root@controller:~# openstack endpoint create --region RegionOne network admin http://controller:9696
+--------------+----------------------------------+
| Field        | Value                            |
+--------------+----------------------------------+
| enabled      | True                             |
| id           | 6a485d5aa03d4b128a9d786be4ff122f |
| interface    | admin                            |
| region       | RegionOne                        |
| region_id    | RegionOne                        |
| service_id   | 2e25614cc66d4069a9123af5d25084ae |
| service_name | neutron                          |
| service_type | network                          |
| url          | http://controller:9696           |
+--------------+----------------------------------+
```
# Install the components
```shell
apt install neutron-server neutron-plugin-ml2 \
  neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent \
  neutron-metadata-agent
```
# Configure the server component
* Edit the /etc/neutron/neutron.conf file and complete the following actions:
```shell
vi /etc/neutron/neutron.conf
```
```shell
[DEFAULT]
core_plugin = ml2
service_plugins = router
transport_url = rabbit://openstack:Passw0rd@controller
auth_strategy = keystone
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true
[agent]
root_helper = "sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf"
[cache]
[cors]
[database]
connection = mysql+pymysql://neutron:Passw0rd@controller/neutron
[designate]
[experimental]
[healthcheck]
[ironic]
[keystone_authtoken]
www_authenticate_uri = http://controller:5000
auth_url = http://controller:5000
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = neutron
password = Passw0rd
[nova]
auth_url = http://controller:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = nova
password = Passw0rd
[oslo_concurrency]
lock_path = /var/lib/neutron/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[oslo_versionedobjects]
[placement]
[privsep]
[profiler]
[quotas]
[ssl]
```
# Configure the Modular Layer 2 (ML2) plug-in
* Edit the /etc/neutron/plugins/ml2/ml2_conf.ini file and complete the following actions:
```shell
vi /etc/neutron/plugins/ml2/ml2_conf.ini
```
```shell
[DEFAULT]
[ml2]
type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
mechanism_drivers = openvswitch,l2population
extension_drivers = port_security
[ml2_type_flat]
flat_networks = provider
[ml2_type_geneve]
[ml2_type_gre]
[ml2_type_vlan]
[ml2_type_vxlan]
vni_ranges = 1:1000
[ovn]
[ovn_nb_global]
[ovs]
[ovs_driver]
[securitygroup]
[sriov_driver]
```
# Configure the Open vSwitch agent
* Edit the /etc/neutron/plugins/ml2/openvswitch_agent.ini file and complete the following actions:
```shell
vi /etc/neutron/plugins/ml2/openvswitch_agent.ini
```
```shell
[DEFAULT]
[agent]
tunnel_types = vxlan
l2_population = true
[dhcp]
[metadata]
[network_log]
[ovs]
bridge_mappings = provider:br-ex
local_ip = 10.0.0.11
[securitygroup]
enable_security_group = true
firewall_driver = openvswitch
```
```shell
ovs-vsctl add-br br-ex
ovs-vsctl add-port br-ex ens224
```
# Configure the layer-3 agent
* Edit the /etc/neutron/l3_agent.ini file and complete the following actions:
```shell
vi /etc/neutron/l3_agent.ini
```
```shell
[DEFAULT]
interface_driver = openvswitch
[agent]
[metadata_rate_limiting]
[network_log]
[ovs]
```
# Configure the DHCP agent
* Edit the /etc/neutron/dhcp_agent.ini file and complete the following actions:
```shell
vi /etc/neutron/dhcp_agent.ini
```
```shell
[DEFAULT]
interface_driver = openvswitch
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = true
[agent]
[metadata_rate_limiting]
[ovs]
```
# Configure the metadata agent
* Edit the /etc/neutron/metadata_agent.ini file and complete the following actions:
```shell
vi /etc/neutron/metadata_agent.ini
```
```shell
[DEFAULT]
nova_metadata_host = controller
metadata_proxy_shared_secret = Passw0rd
[agent]
[cache]
```
# Configure the Compute service to use the Networking service
* Edit the /etc/nova/nova.conf file and perform the following actions:
```shell
vi /etc/nova/nova.conf
```
```shell
[DEFAULT]
my_ip = 10.0.0.11
transport_url = rabbit://openstack:Passw0rd@controller:5672/
log_dir = /var/log/nova
lock_path = /var/lock/nova
state_path = /var/lib/nova
[api]
auth_strategy = keystone
[api_database]
connection = mysql+pymysql://nova:Passw0rd@controller/nova_api
[barbican]
[barbican_service_user]
[cache]
[cinder]
[compute]
[conductor]
[console]
[consoleauth]
[cors]
[cyborg]
[database]
connection = mysql+pymysql://nova:Passw0rd@controller/nova
[devices]
[ephemeral_storage_encryption]
[filter_scheduler]
[glance]
api_servers = http://controller:9292
[guestfs]
[healthcheck]
[image_cache]
[ironic]
[key_manager]
[keystone]
[keystone_authtoken]
www_authenticate_uri = http://controller:5000/
auth_url = http://controller:5000/
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = Passw0rd
[libvirt]
[metrics]
[mks]
[neutron]
auth_url = http://controller:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = neutron
password = Passw0rd
service_metadata_proxy = true
metadata_proxy_shared_secret = Passw0rd
[notifications]
[os_vif_linux_bridge]
[os_vif_ovs]
[oslo_concurrency]
lock_path = /var/lib/nova/tmp
[oslo_limit]
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[oslo_versionedobjects]
[pci]
[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = Passw0rd
[privsep]
[profiler]
[quota]
[remote_debug]
[scheduler]
[serial_console]
[service_user]
send_service_user_token = true
auth_url = http://controller:5000/v3
auth_strategy = keystone
auth_type = password
project_domain_name = Default
project_name = service
user_domain_name = Default
username = nova
password = Passw0rd
[spice]
[upgrade_levels]
[vault]
[vendordata_dynamic_auth]
[vmware]
[vnc]
enabled = true
server_listen = $my_ip
server_proxyclient_address = $my_ip
[workarounds]
[wsgi]
[zvm]
[cells]
enable = False
[os_region_name]
openstack =
```
# Finalize installation
1. Populate the database:
```shell
su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
```
```shell
root@controller:~# su -s /bin/sh -c "neutron-db-manage --config-file /etc/neutron/neutron.conf \
  --config-file /etc/neutron/plugins/ml2/ml2_conf.ini upgrade head" neutron
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
  Running upgrade for neutron ...
INFO  [alembic.runtime.migration] Context impl MySQLImpl.
INFO  [alembic.runtime.migration] Will assume non-transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> kilo
INFO  [alembic.runtime.migration] Running upgrade kilo -> 354db87e3225
INFO  [alembic.runtime.migration] Running upgrade 354db87e3225 -> 599c6a226151
INFO  [alembic.runtime.migration] Running upgrade 599c6a226151 -> 52c5312f6baf
INFO  [alembic.runtime.migration] Running upgrade 52c5312f6baf -> 313373c0ffee
INFO  [alembic.runtime.migration] Running upgrade 313373c0ffee -> 8675309a5c4f
INFO  [alembic.runtime.migration] Running upgrade 8675309a5c4f -> 45f955889773
INFO  [alembic.runtime.migration] Running upgrade 45f955889773 -> 26c371498592
INFO  [alembic.runtime.migration] Running upgrade 26c371498592 -> 1c844d1677f7
INFO  [alembic.runtime.migration] Running upgrade 1c844d1677f7 -> 1b4c6e320f79
INFO  [alembic.runtime.migration] Running upgrade 1b4c6e320f79 -> 48153cb5f051
INFO  [alembic.runtime.migration] Running upgrade 48153cb5f051 -> 9859ac9c136
INFO  [alembic.runtime.migration] Running upgrade 9859ac9c136 -> 34af2b5c5a59
INFO  [alembic.runtime.migration] Running upgrade 34af2b5c5a59 -> 59cb5b6cf4d
INFO  [alembic.runtime.migration] Running upgrade 59cb5b6cf4d -> 13cfb89f881a
INFO  [alembic.runtime.migration] Running upgrade 13cfb89f881a -> 32e5974ada25
INFO  [alembic.runtime.migration] Running upgrade 32e5974ada25 -> ec7fcfbf72ee
INFO  [alembic.runtime.migration] Running upgrade ec7fcfbf72ee -> dce3ec7a25c9
INFO  [alembic.runtime.migration] Running upgrade dce3ec7a25c9 -> c3a73f615e4
INFO  [alembic.runtime.migration] Running upgrade c3a73f615e4 -> 659bf3d90664
INFO  [alembic.runtime.migration] Running upgrade 659bf3d90664 -> 1df244e556f5
INFO  [alembic.runtime.migration] Running upgrade 1df244e556f5 -> 19f26505c74f
INFO  [alembic.runtime.migration] Running upgrade 19f26505c74f -> 15be73214821
INFO  [alembic.runtime.migration] Running upgrade 15be73214821 -> b4caf27aae4
INFO  [alembic.runtime.migration] Running upgrade b4caf27aae4 -> 15e43b934f81
INFO  [alembic.runtime.migration] Running upgrade 15e43b934f81 -> 31ed664953e6
INFO  [alembic.runtime.migration] Running upgrade 31ed664953e6 -> 2f9e956e7532
INFO  [alembic.runtime.migration] Running upgrade 2f9e956e7532 -> 3894bccad37f
INFO  [alembic.runtime.migration] Running upgrade 3894bccad37f -> 0e66c5227a8a
INFO  [alembic.runtime.migration] Running upgrade 0e66c5227a8a -> 45f8dd33480b
INFO  [alembic.runtime.migration] Running upgrade 45f8dd33480b -> 5abc0278ca73
INFO  [alembic.runtime.migration] Running upgrade 5abc0278ca73 -> d3435b514502
INFO  [alembic.runtime.migration] Running upgrade d3435b514502 -> 30107ab6a3ee
INFO  [alembic.runtime.migration] Running upgrade 30107ab6a3ee -> c415aab1c048
INFO  [alembic.runtime.migration] Running upgrade c415aab1c048 -> a963b38d82f4
INFO  [alembic.runtime.migration] Running upgrade kilo -> 30018084ec99
INFO  [alembic.runtime.migration] Running upgrade 30018084ec99 -> 4ffceebfada
INFO  [alembic.runtime.migration] Running upgrade 4ffceebfada -> 5498d17be016
INFO  [alembic.runtime.migration] Running upgrade 5498d17be016 -> 2a16083502f3
INFO  [alembic.runtime.migration] Running upgrade 2a16083502f3 -> 2e5352a0ad4d
INFO  [alembic.runtime.migration] Running upgrade 2e5352a0ad4d -> 11926bcfe72d
INFO  [alembic.runtime.migration] Running upgrade 11926bcfe72d -> 4af11ca47297
INFO  [alembic.runtime.migration] Running upgrade 4af11ca47297 -> 1b294093239c
INFO  [alembic.runtime.migration] Running upgrade 1b294093239c -> 8a6d8bdae39
INFO  [alembic.runtime.migration] Running upgrade 8a6d8bdae39 -> 2b4c2465d44b
INFO  [alembic.runtime.migration] Running upgrade 2b4c2465d44b -> e3278ee65050
INFO  [alembic.runtime.migration] Running upgrade e3278ee65050 -> c6c112992c9
INFO  [alembic.runtime.migration] Running upgrade c6c112992c9 -> 5ffceebfada
INFO  [alembic.runtime.migration] Running upgrade 5ffceebfada -> 4ffceebfcdc
INFO  [alembic.runtime.migration] Running upgrade 4ffceebfcdc -> 7bbb25278f53
INFO  [alembic.runtime.migration] Running upgrade 7bbb25278f53 -> 89ab9a816d70
INFO  [alembic.runtime.migration] Running upgrade 89ab9a816d70 -> c879c5e1ee90
INFO  [alembic.runtime.migration] Running upgrade c879c5e1ee90 -> 8fd3918ef6f4
INFO  [alembic.runtime.migration] Running upgrade 8fd3918ef6f4 -> 4bcd4df1f426
INFO  [alembic.runtime.migration] Running upgrade 4bcd4df1f426 -> b67e765a3524
INFO  [alembic.runtime.migration] Running upgrade a963b38d82f4 -> 3d0e74aa7d37
INFO  [alembic.runtime.migration] Running upgrade 3d0e74aa7d37 -> 030a959ceafa
INFO  [alembic.runtime.migration] Running upgrade 030a959ceafa -> a5648cfeeadf
INFO  [alembic.runtime.migration] Running upgrade a5648cfeeadf -> 0f5bef0f87d4
INFO  [alembic.runtime.migration] Running upgrade 0f5bef0f87d4 -> 67daae611b6e
INFO  [alembic.runtime.migration] Running upgrade b67e765a3524 -> a84ccf28f06a
INFO  [alembic.runtime.migration] Running upgrade a84ccf28f06a -> 7d9d8eeec6ad
INFO  [alembic.runtime.migration] Running upgrade 67daae611b6e -> 6b461a21bcfc
INFO  [alembic.runtime.migration] Running upgrade 6b461a21bcfc -> 5cd92597d11d
INFO  [alembic.runtime.migration] Running upgrade 5cd92597d11d -> 929c968efe70
INFO  [alembic.runtime.migration] Running upgrade 929c968efe70 -> a9c43481023c
INFO  [alembic.runtime.migration] Running upgrade a9c43481023c -> 804a3c76314c
INFO  [alembic.runtime.migration] Running upgrade 804a3c76314c -> 2b42d90729da
INFO  [alembic.runtime.migration] Running upgrade 2b42d90729da -> 62c781cb6192
INFO  [alembic.runtime.migration] Running upgrade 62c781cb6192 -> c8c222d42aa9
INFO  [alembic.runtime.migration] Running upgrade c8c222d42aa9 -> 349b6fd605a6
INFO  [alembic.runtime.migration] Running upgrade 349b6fd605a6 -> 7d32f979895f
INFO  [alembic.runtime.migration] Running upgrade 7d32f979895f -> 594422d373ee
INFO  [alembic.runtime.migration] Running upgrade 594422d373ee -> 61663558142c
INFO  [alembic.runtime.migration] Running upgrade 61663558142c -> 867d39095bf4, port forwarding
INFO  [alembic.runtime.migration] Running upgrade 867d39095bf4 -> d72db3e25539, modify uniq port forwarding
INFO  [alembic.runtime.migration] Running upgrade d72db3e25539 -> cada2437bf41
INFO  [alembic.runtime.migration] Running upgrade cada2437bf41 -> 195176fb410d, router gateway IP QoS
INFO  [alembic.runtime.migration] Running upgrade 195176fb410d -> fb0167bd9639
INFO  [alembic.runtime.migration] Running upgrade fb0167bd9639 -> 0ff9e3881597
INFO  [alembic.runtime.migration] Running upgrade 0ff9e3881597 -> 9bfad3f1e780
INFO  [alembic.runtime.migration] Running upgrade 9bfad3f1e780 -> 63fd95af7dcd
INFO  [alembic.runtime.migration] Running upgrade 63fd95af7dcd -> c613d0b82681
INFO  [alembic.runtime.migration] Running upgrade c613d0b82681 -> c3e9d13c4367
INFO  [alembic.runtime.migration] Running upgrade c3e9d13c4367 -> 86274d77933e
INFO  [alembic.runtime.migration] Running upgrade 86274d77933e -> f4b9654dd40c
INFO  [alembic.runtime.migration] Running upgrade f4b9654dd40c -> a010322604bc
INFO  [alembic.runtime.migration] Running upgrade a010322604bc -> 263d454a9655
INFO  [alembic.runtime.migration] Running upgrade 263d454a9655 -> Ibac91d24da2
INFO  [alembic.runtime.migration] Running upgrade Ibac91d24da2 -> 2217c4222de6
INFO  [alembic.runtime.migration] Running upgrade 2217c4222de6 -> 18a7e90ae768
INFO  [alembic.runtime.migration] Running upgrade 18a7e90ae768 -> e4e236b0e1ff
INFO  [alembic.runtime.migration] Running upgrade e4e236b0e1ff -> e88badaa9591
INFO  [alembic.runtime.migration] Running upgrade e88badaa9591 -> d8bdf05313f4
INFO  [alembic.runtime.migration] Running upgrade d8bdf05313f4 -> dfe425060830
INFO  [alembic.runtime.migration] Running upgrade dfe425060830 -> fd6107509ccd
INFO  [alembic.runtime.migration] Running upgrade fd6107509ccd -> 1ea5dab0897a
INFO  [alembic.runtime.migration] Running upgrade 1ea5dab0897a -> 49d8622c5221
INFO  [alembic.runtime.migration] Running upgrade 49d8622c5221 -> I38991de2b4
INFO  [alembic.runtime.migration] Running upgrade I38991de2b4 -> 532aa95457e2
INFO  [alembic.runtime.migration] Running upgrade 532aa95457e2 -> f010820fc498
INFO  [alembic.runtime.migration] Running upgrade f010820fc498 -> a964d94b4677
INFO  [alembic.runtime.migration] Running upgrade a964d94b4677 -> 26d1e9f5c766
INFO  [alembic.runtime.migration] Running upgrade 26d1e9f5c766 -> 1e0744e4ffea
INFO  [alembic.runtime.migration] Running upgrade 1e0744e4ffea -> 6135a7bd4425
INFO  [alembic.runtime.migration] Running upgrade 6135a7bd4425 -> 8df53b0d2c0e
INFO  [alembic.runtime.migration] Running upgrade 8df53b0d2c0e -> 1bb3393de75d, add qos policy rule Packet Rate Limit
INFO  [alembic.runtime.migration] Running upgrade 1bb3393de75d -> c181bb1d89e4
INFO  [alembic.runtime.migration] Running upgrade c181bb1d89e4 -> ba859d649675
INFO  [alembic.runtime.migration] Running upgrade ba859d649675 -> e981acd076d3
INFO  [alembic.runtime.migration] Running upgrade e981acd076d3 -> 76df7844a8c6, add Local IP tables
INFO  [alembic.runtime.migration] Running upgrade 76df7844a8c6 -> 1ffef8d6f371, migrate RBAC registers from "target_tenant" to "target_project"
INFO  [alembic.runtime.migration] Running upgrade 1ffef8d6f371 -> 8160f7a9cebb, drop portbindingports table
INFO  [alembic.runtime.migration] Running upgrade 8160f7a9cebb -> cd9ef14ccf87
INFO  [alembic.runtime.migration] Running upgrade cd9ef14ccf87 -> 34cf8b009713
INFO  [alembic.runtime.migration] Running upgrade 34cf8b009713 -> I43e0b669096
INFO  [alembic.runtime.migration] Running upgrade I43e0b669096 -> 4e6e655746f6
INFO  [alembic.runtime.migration] Running upgrade 4e6e655746f6 -> 659cbedf30a1
INFO  [alembic.runtime.migration] Running upgrade 659cbedf30a1 -> 21ff98fabab1
INFO  [alembic.runtime.migration] Running upgrade 21ff98fabab1 -> 5881373af7f5
INFO  [alembic.runtime.migration] Running upgrade 5881373af7f5 -> fc153938cdc1
INFO  [alembic.runtime.migration] Running upgrade fc153938cdc1 -> 93f394357a27
INFO  [alembic.runtime.migration] Running upgrade 93f394357a27 -> 6f1145bff34c
INFO  [alembic.runtime.migration] Running upgrade 6f1145bff34c -> 682c319773d7
INFO  [alembic.runtime.migration] Running upgrade 682c319773d7 -> 0aefee21cd87
INFO  [alembic.runtime.migration] Running upgrade 0aefee21cd87 -> b1199a3adbef
INFO  [alembic.runtime.migration] Running upgrade b1199a3adbef -> c33da356b165
INFO  [alembic.runtime.migration] Running upgrade c33da356b165 -> 89c58a70ceba
INFO  [alembic.runtime.migration] Running upgrade 89c58a70ceba -> 054e34dbe6b4
INFO  [alembic.runtime.migration] Running upgrade 054e34dbe6b4 -> 0e6eff810791
INFO  [alembic.runtime.migration] Running upgrade 7d9d8eeec6ad -> a8b517cff8ab
INFO  [alembic.runtime.migration] Running upgrade a8b517cff8ab -> 3b935b28e7a0
INFO  [alembic.runtime.migration] Running upgrade 3b935b28e7a0 -> b12a3ef66e62
INFO  [alembic.runtime.migration] Running upgrade b12a3ef66e62 -> 97c25b0d2353
INFO  [alembic.runtime.migration] Running upgrade 97c25b0d2353 -> 2e0d7a8a1586
INFO  [alembic.runtime.migration] Running upgrade 2e0d7a8a1586 -> 5c85685d616d
  OK
```
2. Restart the Compute API service:
```shell
systemctl restart nova-api
```
3. Restart the Networking services.
```shell
systemctl enable neutron-server
systemctl enable neutron-openvswitch-agent
systemctl enable neutron-dhcp-agent
systemctl enable neutron-metadata-agent
systemctl enable neutron-l3-agent
systemctl restart neutron-server
systemctl restart neutron-openvswitch-agent
systemctl restart neutron-dhcp-agent
systemctl restart neutron-metadata-agent
systemctl restart neutron-l3-agent
```
# Run on Compute Node
# Install the components
```shell
apt install neutron-openvswitch-agent
```
# Configure the common component
* Edit the /etc/neutron/neutron.conf file and complete the following actions:
```shell
vi /etc/neutron/neutron.conf
```
```shell
[DEFAULT]
transport_url = rabbit://openstack:Passw0rd@controller
core_plugin = ml2 
[agent]
root_helper = "sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf"
[cache]
[cors]
[database]
[healthcheck]
[ironic]
[keystone_authtoken]
[nova]
[oslo_concurrency]
lock_path = /var/lib/neutron/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[placement]
[privsep]
[profiler]
[quotas]
[ssl]
```
# Configure the Open vSwitch agent
* Edit the /etc/neutron/plugins/ml2/openvswitch_agent.ini file and complete the following actions:
```shell
vi /etc/neutron/plugins/ml2/openvswitch_agent.ini
```
```shell
[DEFAULT]
[agent]
tunnel_types = vxlan
l2_population = true
[dhcp]
[network_log]
[ovs]
bridge_mappings = provider:br-ex
local_ip = 10.0.0.31
[securitygroup]
enable_security_group = true
firewall_driver = openvswitch
```
```shell
root@compute1:~# ovs-vsctl add-br br-ex
root@compute1:~# ovs-vsctl add-port br-ex ens224
```
# Configure the Compute service to use the Networking service
* Edit the /etc/nova/nova.conf file and complete the following actions:
```shell
vi /etc/nova/nova.conf
```
```shell
[DEFAULT]
my_ip = 10.0.0.31
transport_url = rabbit://openstack:Passw0rd@controller
log_dir = /var/log/nova
lock_path = /var/lock/nova
state_path = /var/lib/nova
[api]
auth_strategy = keystone
[api_database]
[barbican]
[barbican_service_user]
[cache]
[cinder]
[compute]
[conductor]
[console]
[consoleauth]
[cors]
[cyborg]
[database]
[devices]
[ephemeral_storage_encryption]
[filter_scheduler]
[glance]
api_servers = http://controller:9292
[guestfs]
[healthcheck]
[hyperv]
[image_cache]
[ironic]
[key_manager]
[keystone]
[keystone_authtoken]
www_authenticate_uri = http://controller:5000/
auth_url = http://controller:5000/
memcached_servers = controller:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = nova
password = Passw0rd
[libvirt]
[metrics]
[mks]
[neutron]
auth_url = http://controller:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = neutron
password = Passw0rd
[notifications]
[oslo_concurrency]
lock_path = /var/lib/nova/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[pci]
[placement]
region_name = RegionOne
project_domain_name = Default
project_name = service
auth_type = password
user_domain_name = Default
auth_url = http://controller:5000/v3
username = placement
password = Passw0rd
[powervm]
[privsep]
[profiler]
[quota]
[rdp]
[remote_debug]
[scheduler]
[serial_console]
[service_user]
send_service_user_token = true
auth_url = http://controller:5000/v3
auth_strategy = keystone
auth_type = password
project_domain_name = Default
project_name = service
user_domain_name = Default
username = nova
password = Passw0rd
[spice]
[upgrade_levels]
[vault]
[vendordata_dynamic_auth]
[vmware]
[vnc]
enabled = true
server_listen = 0.0.0.0
server_proxyclient_address = $my_ip
novncproxy_base_url = http://controller:6080/vnc_auto.html
[workarounds]
[wsgi]
[zvm]
[cells]
enable = False
[os_region_name]
openstack =
```
# Finalize installation
1. Restart the Compute service:
```shell
systemctl enable nova-compute
systemctl restart nova-compute
```
2. Restart the Linux bridge agent:
```shell
systemctl enable neutron-openvswitch-agent
systemctl restart neutron-openvswitch-agent
```
# Verify operation
# Run on Controller Node
1. List loaded extensions to verify successful launch of the neutron-server process:
```shell
root@controller:~# openstack extension list --network
+----------------------------------------------------------------------+---------------------------------------------+----------------------------------------------------------------------+
| Name                                                                 | Alias                                       | Description                                                          |
+----------------------------------------------------------------------+---------------------------------------------+----------------------------------------------------------------------+
| Address group                                                        | address-group                               | Support address group                                                |
| Address scope                                                        | address-scope                               | Address scopes extension.                                            |
| Enforce Router's Admin State Down Before Update Extension            | router-admin-state-down-before-update       | Ensure that the admin state of a router is DOWN                      |
|                                                                      |                                             | (admin_state_up=False) before updating the distributed attribute     |
| agent                                                                | agent                                       | The agent management extension.                                      |
| Agent's Resource View Synced to Placement                            | agent-resources-synced                      | Stores success/failure of last sync to Placement                     |
| Allowed Address Pairs                                                | allowed-address-pairs                       | Provides allowed address pairs                                       |
| Auto Allocated Topology Services                                     | auto-allocated-topology                     | Auto Allocated Topology Services.                                    |
| Availability Zone                                                    | availability_zone                           | The availability zone extension.                                     |
| Availability Zone Filter Extension                                   | availability_zone_filter                    | Add filter parameters to AvailabilityZone resource                   |
| Default Subnetpools                                                  | default-subnetpools                         | Provides ability to mark and use a subnetpool as the default.        |
| DHCP Agent Scheduler                                                 | dhcp_agent_scheduler                        | Schedule networks among dhcp agents                                  |
| Distributed Virtual Router                                           | dvr                                         | Enables configuration of Distributed Virtual Routers.                |
| Empty String Filtering Extension                                     | empty-string-filtering                      | Allow filtering by attributes with empty string value                |
| Neutron external network                                             | external-net                                | Adds external network attribute to network resource.                 |
| Neutron Extra DHCP options                                           | extra_dhcp_opt                              | Extra options configuration for DHCP. For example PXE boot options   |
|                                                                      |                                             | to DHCP clients can be specified (e.g. tftp-server, server-ip-       |
|                                                                      |                                             | address, bootfile-name)                                              |
| Neutron Extra Route                                                  | extraroute                                  | Extra routes configuration for L3 router                             |
| Atomically add/remove extra routes                                   | extraroute-atomic                           | Edit extra routes of a router on server side by atomically           |
|                                                                      |                                             | adding/removing extra routes                                         |
| Filter parameters validation                                         | filter-validation                           | Provides validation on filter parameters.                            |
| Floating IP port forwarding detail                                   | floating-ip-port-forwarding-detail          | Allow list floating ip return more port forwarding data, include'id' |
|                                                                      |                                             | and 'internal_port_id'                                               |
| Floating IP Port Details Extension                                   | fip-port-details                            | Add port_details attribute to Floating IP resource                   |
| Neutron Service Flavors                                              | flavors                                     | Flavor specification for Neutron advanced services.                  |
| Floating IP Pools Extension                                          | floatingip-pools                            | Provides a floating IP pools API.                                    |
| IP address substring filtering                                       | ip-substring-filtering                      | Provides IP address substring filtering when listing ports           |
| Neutron L3 Router                                                    | router                                      | Router abstraction for basic L3 forwarding between L2 Neutron        |
|                                                                      |                                             | networks and access to external networks via a NAT gateway.          |
| Neutron L3 Configurable external gateway mode                        | ext-gw-mode                                 | Extension of the router abstraction for specifying whether SNAT      |
|                                                                      |                                             | should occur on the external gateway                                 |
| HA Router extension                                                  | l3-ha                                       | Adds HA capability to routers.                                       |
| Router Flavor Extension                                              | l3-flavors                                  | Flavor support for routers.                                          |
| Prevent L3 router ports IP address change extension                  | l3-port-ip-change-not-allowed               | Prevent change of IP address for some L3 router ports                |
| L3 Agent Scheduler                                                   | l3_agent_scheduler                          | Schedule routers among l3 agents                                     |
| Multi Provider Network                                               | multi-provider                              | Expose mapping of virtual networks to multiple physical networks     |
| Network MTU                                                          | net-mtu                                     | Provides MTU attribute for a network resource.                       |
| Network MTU (writable)                                               | net-mtu-writable                            | Provides a writable MTU attribute for a network resource.            |
| Network Availability Zone                                            | network_availability_zone                   | Availability zone support for network.                               |
| Network HA creation flag                                             | network_ha                                  | Network high availability creation flag.                             |
| Network IP Availability                                              | network-ip-availability                     | Provides IP availability data for each network and subnet.           |
| Pagination support                                                   | pagination                                  | Extension that indicates that pagination is enabled.                 |
| Port device profile                                                  | port-device-profile                         | Expose the port device profile (Cyborg)                              |
| Port hardware offload                                                | port-hardware-offload-type                  | Expose port hardware offload extension                               |
| Neutron Port MAC address override                                    | port-mac-override                           | Allow overriding the MAC address of a direct-physical Port via the   |
|                                                                      |                                             | active binding profile                                               |
| Neutron Port MAC address regenerate                                  | port-mac-address-regenerate                 | Network port MAC address regenerate                                  |
| Port NUMA affinity policy                                            | port-numa-affinity-policy                   | Expose the port NUMA affinity policy                                 |
| Port Binding                                                         | binding                                     | Expose port bindings of a virtual port to external application       |
| Port Bindings Extended                                               | binding-extended                            | Expose port bindings of a virtual port to external application       |
| Port Security                                                        | port-security                               | Provides port security                                               |
| project_id field enabled                                             | project-id                                  | Extension that indicates that project_id field is enabled.           |
| Provider Network                                                     | provider                                    | Expose mapping of virtual networks to physical networks              |
| Quota engine limit check                                             | quota-check-limit                           | Support for checking the resource usage before applying a new quota  |
|                                                                      |                                             | limit                                                                |
| Quota management support                                             | quotas                                      | Expose functions for quotas management per project                   |
| Quota details management support                                     | quota_details                               | Expose functions for quotas usage statistics per project             |
| RBAC Policies                                                        | rbac-policies                               | Allows creation and modification of policies that control tenant     |
|                                                                      |                                             | access to resources.                                                 |
| Add address_group type to RBAC                                       | rbac-address-group                          | Add address_group type to network RBAC                               |
| Add address_scope type to RBAC                                       | rbac-address-scope                          | Add address_scope type to RBAC                                       |
| Add security_group type to network RBAC                              | rbac-security-groups                        | Add security_group type to network RBAC                              |
| Add subnetpool type to RBAC                                          | rbac-subnetpool                             | Add subnetpool type to RBAC                                          |
| If-Match constraints based on revision_number                        | revision-if-match                           | Extension indicating that If-Match based on revision_number is       |
|                                                                      |                                             | supported.                                                           |
| Resource revision numbers                                            | standard-attr-revisions                     | This extension will display the revision number of neutron           |
|                                                                      |                                             | resources.                                                           |
| Router Availability Zone                                             | router_availability_zone                    | Availability zone support for router.                                |
| Default rules for security groups                                    | security-groups-default-rules               | Configure set of security group rules used as default rules for      |
|                                                                      |                                             | every new security group                                             |
| Normalized CIDR field for security group rules                       | security-groups-normalized-cidr             | Add new field with normalized remote_ip_prefix cidr in SG rule       |
| Port filtering on security groups                                    | port-security-groups-filtering              | Provides security groups filtering when listing ports                |
| Remote address group id field for security group rules               | security-groups-remote-address-group        | Add new field of remote address group id in SG rules                 |
| Security group rule belongs to the project's default security group  | security-groups-rules-belongs-to-default-sg | Flag to determine if the security group rule belongs to the          |
|                                                                      |                                             | project's default security group                                     |
| Security group filtering on the shared field                         | security-groups-shared-filtering            | Support filtering security groups on the shared field                |
| security-group                                                       | security-group                              | The security groups extension.                                       |
| Neutron Service Type Management                                      | service-type                                | API for retrieving service providers for Neutron advanced services   |
| Sorting support                                                      | sorting                                     | Extension that indicates that sorting is enabled.                    |
| standard-attr-description                                            | standard-attr-description                   | Extension to add descriptions to standard attributes                 |
| Stateful security group                                              | stateful-security-group                     | Indicates if the security group is stateful or not                   |
| Subnet Onboard                                                       | subnet_onboard                              | Provides support for onboarding subnets into subnet pools            |
| Subnet service types                                                 | subnet-service-types                        | Provides ability to set the subnet service_types field               |
| Subnet Allocation                                                    | subnet_allocation                           | Enables allocation of subnets from a subnet pool                     |
| Subnet Pool Prefix Operations                                        | subnetpool-prefix-ops                       | Provides support for adjusting the prefix list of subnet pools       |
| Tag support for resources with standard attribute: port, subnet,     | standard-attr-tag                           | Enables to set tag on resources with standard attribute.             |
| subnetpool, network, security_group, router, floatingip, policy,     |                                             |                                                                      |
| trunk, network_segment_range                                         |                                             |                                                                      |
| Resource timestamps                                                  | standard-attr-timestamp                     | Adds created_at and updated_at fields to all Neutron resources that  |
|                                                                      |                                             | have Neutron standard attributes.                                    |
+----------------------------------------------------------------------+---------------------------------------------+----------------------------------------------------------------------+
```
2. List agents to verify successful launch of the neutron agents:
```shell
root@controller:~# openstack network agent list
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
| ID                                   | Agent Type         | Host       | Availability Zone | Alive | State | Binary                    |
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
| 507c5276-4f43-49bc-ae9e-ae97297cb37a | Metadata agent     | controller | None              | :-)   | UP    | neutron-metadata-agent    |
| 6a637824-ed29-4b93-9224-8050b71334bf | Open vSwitch agent | controller | None              | :-)   | UP    | neutron-openvswitch-agent |
| db0684a6-beef-4d27-9114-809fc166284a | Open vSwitch agent | compute1   | None              | :-)   | UP    | neutron-openvswitch-agent |
| dd086e66-e95b-4e78-85b3-7edc6d046391 | L3 agent           | controller | nova              | :-)   | UP    | neutron-l3-agent          |
| fdd8b6ab-1f35-4924-96c1-a70a7671238e | DHCP agent         | controller | nova              | :-)   | UP    | neutron-dhcp-agent        |
+--------------------------------------+--------------------+------------+-------------------+-------+-------+---------------------------+
```



