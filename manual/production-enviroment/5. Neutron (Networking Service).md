# Run on Controller
## Prerequisites
---
### Prepare MySQL Database
```shell
mysql
```
```shell
CREATE DATABASE neutron;
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'localhost' IDENTIFIED BY 'Passw0rd';
GRANT ALL PRIVILEGES ON neutron.* TO 'neutron'@'%' IDENTIFIED BY 'Passw0rd';
EXIT;
```
### Prepare Keystone
```shell
. admin-openrc
```
```shell
openstack user create --domain default --password 'OpenStack' neutron
openstack role add --project service --user neutron admin
openstack service create --name neutron --description "OpenStack Networking" network
openstack endpoint create --region RegionOne network public https://neutron.kbuor.io.vn:9696
openstack endpoint create --region RegionOne network internal https://neutron.kbuor.io.vn:9696
openstack endpoint create --region RegionOne network admin https://neutron.kbuor.io.vn:9696
```
# Run on Neutron Node
## Install Package and Configure
---
```shell
apt install -y neutron-server neutron-plugin-ml2 neutron-openvswitch-agent neutron-l3-agent neutron-dhcp-agent neutron-metadata-agent
```
```shell
cat <<'EOF' > /etc/neutron/neutron.conf
[DEFAULT]
core_plugin = ml2
service_plugins = router
transport_url = rabbit://openstack:OpenStack@controller01.openstack.local
auth_strategy = keystone
notify_nova_on_port_status_changes = true
notify_nova_on_port_data_changes = true
[agent]
root_helper = "sudo /usr/bin/neutron-rootwrap /etc/neutron/rootwrap.conf"
[cache]
[cors]
[database]
connection = mysql+pymysql://neutron:OpenStack@controller01.openstack.local/neutron
[designate]
[experimental]
[healthcheck]
[ironic]
[keystone_authtoken]
www_authenticate_uri = https://keystone.kbuor.io.vn:5000
auth_url = https://keystone.kbuor.io.vn:5000
memcached_servers = controller01.openstack.local:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = neutron
password = OpenStack
[nova]
auth_url = https://keystone.kbuor.io.vn:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = nova
password = OpenStack
[oslo_concurrency]
lock_path = /var/lib/neutron/tmp
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[oslo_versionedobjects]
[placement]
[privsep]
[profiler]
[quotas]
[ssl]
EOF
```
```shell
cat <<'EOF' > /etc/neutron/plugins/ml2/ml2_conf.ini
[DEFAULT]
[ml2]
type_drivers = flat,vlan,vxlan
tenant_network_types = vxlan
mechanism_drivers = openvswitch,l2population
extension_drivers = port_security
[ml2_type_flat]
flat_networks = provider
[ml2_type_geneve]
[ml2_type_gre]
[ml2_type_vlan]
[ml2_type_vxlan]
vni_ranges = 1:1000
[ovn]
[ovn_nb_global]
[ovs]
[ovs_driver]
[securitygroup]
[sriov_driver]
EOF
```
```shell
ovs-vsctl add-br provider-br-01
ovs-vsctl add-port provider-br-01 ens224
```
```shell
cat <<'EOF' > /etc/neutron/plugins/ml2/openvswitch_agent.ini
[DEFAULT]
[agent]
tunnel_types = vxlan
l2_population = true
[dhcp]
[metadata]
[network_log]
[ovs]
bridge_mappings = provider-network-01:provider-br-01
local_ip = 13.28.4.61
[securitygroup]
enable_security_group = true
firewall_driver = openvswitch
EOF
```
```shell
cat <<'EOF' > /etc/neutron/l3_agent.ini
[DEFAULT]
interface_driver = openvswitch
[agent]
[metadata_rate_limiting]
[network_log]
[ovs]
EOF
```
```shell
cat <<'EOF' > /etc/neutron/dhcp_agent.ini
[DEFAULT]
interface_driver = openvswitch
dhcp_driver = neutron.agent.linux.dhcp.Dnsmasq
enable_isolated_metadata = true
[agent]
[metadata_rate_limiting]
[ovs]
EOF
```
```shell
cat <<'EOF' > /etc/neutron/metadata_agent.ini
[DEFAULT]
nova_metadata_host = controller
metadata_proxy_shared_secret = Passw0rd
[agent]
[cache]
EOF
```
# Run on Controller
## Update Nova configure `/etc/nova/nova.conf` for Neutron section
---
```shell
[neutron]
auth_url = https://keystone.kbuor.io.vn:5000
auth_type = password
project_domain_name = Default
user_domain_name = Default
region_name = RegionOne
project_name = service
username = neutron
password = OpenStack
service_metadata_proxy = true
metadata_proxy_shared_secret = OpenStack
```
