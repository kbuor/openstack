# Triển khai Cinder trên Controller và Cinder Node

## Prerequisites

### 1. Chuẩn bị Cơ sở dữ liệu cho Cinder
```shell
# Đăng nhập vào MySQL
mysql
```
```sql
-- Tạo database cinder
CREATE DATABASE cinder;

-- Cấp quyền cho user neutron
GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'localhost' IDENTIFIED BY 'OpenStack';
GRANT ALL PRIVILEGES ON cinder.* TO 'cinder'@'%' IDENTIFIED BY 'OpenStack';

-- Thoát MySQL
EXIT;
```

### 2. Chuẩn bị Keystone
```shell
# Load biến môi trường admin
. admin-openrc
```
```shell
# Tạo user neutron và các endpoint
openstack user create --domain default --password 'OpenStack' cinder
openstack role add --project service --user cinder admin
openstack service create --name cinderv3 --description "OpenStack Block Storage" volumev3
openstack endpoint create --region RegionOne network public https://cinder.tpcoms.ai.vn:8776/v3/%\(project_id\)s
openstack endpoint create --region RegionOne network internal https://cinder.tpcoms.ai.vn:8776/v3/%\(project_id\)s
openstack endpoint create --region RegionOne network admin https://cinder.tpcoms.ai.vn:8776/v3/%\(project_id\)s
```

---

## Cài đặt và cấu hình Neutron trên Neutron Node

### 3. Cài đặt package Cinder
```shell
apt install -y cinder-api cinder-scheduler
```

### 4. Cấu hình các file cấu hình Cinder
#### cinder.conf
```shell
cat <<'EOF' > /etc/cinder/cinder.conf
[DEFAULT]
rootwrap_config = /etc/cinder/rootwrap.conf
api_paste_confg = /etc/cinder/api-paste.ini
iscsi_helper = lioadm
volume_name_template = volume-%s
volume_group = cinder-volumes
verbose = True
auth_strategy = keystone
state_path = /var/lib/cinder
lock_path = /var/lock/cinder
volumes_dir = /var/lib/cinder/volumes
enabled_backends = lvm
transport_url = rabbit://openstack:OpenStack@controller01.openstack.local
my_ip = 10.20.30.11

[database]
connection = mysql+pymysql://cinder:OpenStack@controller01.openstack.local/cinder

[keystone_authtoken]
www_authenticate_uri = https://keystone.tpcoms.ai:5000
auth_url = https://keystone.tpcoms.ai:5000
memcached_servers = controller01.openstack.local:11211
auth_type = password
project_domain_name = default
user_domain_name = default
project_name = service
username = cinder
password = OpenStack

[oslo_concurrency]
lock_path = /var/lib/cinder/tmp
EOF
```

---

## Đồng bộ database và khởi động dịch vụ Cinder

### 5. Đồng bộ CSDL Cinder
```shell
su -s /bin/sh -c "cinder-manage db sync" cinder
```

---

## Cập nhật Nova để tích hợp Neutron (trên Controller Node)

### 6. Chỉnh sửa file `/etc/nova/nova.conf`
```ini
[cinder]
os_region_name = RegionOne
```

---

### 7. Khởi động các dịch vụ Cinder
```shell
systemctl enable cinder-scheduler
systemctl restart cinder-scheduler
```

---

## Chạy Neutron API bằng Apache HTTPD

### 8. Vô hiệu hóa neutron-server và tạo WSGI script
```shell
systemctl disable neutron-server
systemctl stop neutron-server

apt install apache2 libapache2-mod-wsgi-py3 -y
```

### 9. Tạo VirtualHost chạy Neutron API qua HTTPS
```shell
cat <<'EOF' > /etc/apache2/sites-available/neutron-https.conf
<VirtualHost *:9696>
    ServerName neutron.kbuor.io.vn

    SSLEngine on
    SSLCertificateFile /etc/ssl/openstack/openstack.crt
    SSLCertificateKeyFile /etc/ssl/openstack/openstack.key

    WSGIDaemonProcess neutron user=neutron group=neutron processes=4 threads=10 display-name=%{GROUP}
    WSGIProcessGroup neutron
    WSGIScriptAlias / /usr/bin/neutron-api

    <Directory /usr/bin>
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/neutron_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/neutron_ssl_access.log combined
</VirtualHost>
EOF

echo 'Listen 9696' >> /etc/apache2/ports.conf
```

### 10. Bật HTTPS cho Neutron và khởi động Apache
```shell
a2enmod ssl
a2ensite neutron-https
systemctl restart apache2
systemctl reload apache2
```

---

## Ghi chú
- Đảm bảo các hostname như `controller01.openstack.local`, `neutron.kbuor.io.vn`, và `keystone.kbuor.io.vn` đã được khai báo đúng trong DNS hoặc `/etc/hosts`.
- Địa chỉ `ens224`, `13.28.4.61` cần thay đổi phù hợp với hạ tầng mạng thực tế của bạn.
