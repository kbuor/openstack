# Run on Controller
## Prerequisites
---
### Prepare SQL Databases
```shell
mysql
```
```shell
CREATE DATABASE glance;
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'localhost' IDENTIFIED BY 'OpenStack';
GRANT ALL PRIVILEGES ON glance.* TO 'glance'@'%' IDENTIFIED BY 'OpenStack';
EXIT;
```
### Prepare Keystone
```shell
. admin-openrc
```
```shell
openstack user create --domain default --password 'OpenStack' glance
openstack role add --project service --user glance admin
openstack service create --name glance --description "OpenStack Image" image
openstack endpoint create --region RegionOne image public https://glance.kbuor.io.vn:9292
openstack endpoint create --region RegionOne image internal https://glance.kbuor.io.vn:9292
openstack endpoint create --region RegionOne image admin https://glance.kbuor.io.vn:9292
```
## Install and configure components
---
```shell
apt install glance -y
```
```shell
cat <<'EOF' > /etc/glance/glance-api.conf
[DEFAULT]
enabled_backends=fs:file
[barbican]
[barbican_service_user]
[cinder]
[cors]
[database]
connection = mysql+pymysql://glance:OpenStack@controller01.openstack.local/glance
backend = sqlalchemy
[file]
[fs]
filesystem_store_datadir = /var/lib/glance/images/
[glance.store.http.store]
[glance.store.rbd.store]
[glance.store.s3.store]
[glance.store.swift.store]
[glance.store.vmware_datastore.store]
[glance_store]
default_backend = fs
[healthcheck]
[image_format]
disk_formats = ami,ari,aki,vhd,vhdx,vmdk,raw,qcow2,vdi,iso,ploop.root-tar
[key_manager]
[keystone_authtoken]
www_authenticate_uri  = https://keystone.kbuor.io.vn:5000
auth_url = https://keystone.kbuor.io.vn:5000
memcached_servers = controller01.openstack.local:11211
auth_type = password
project_domain_name = Default
user_domain_name = Default
project_name = service
username = glance
password = OpenStack
[os_brick]
[oslo_concurrency]
[oslo_limit]
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[oslo_reports]
[paste_deploy]
flavor = keystone
[profiler]
[store_type_location_strategy]
[task]
[taskflow_executor]
[vault]
[wsgi]
EOF
```
```shell
openstack role add --user glance --user-domain Default --system all reader
```
```shell
su -s /bin/sh -c "glance-manage db_sync" glance
```
## Configure the Apache HTTP server
---
```shell
cat <<'EOF' > /etc/apache2/sites-available/glance-https.conf
<VirtualHost *:9292>
    ServerName controller.tpgo.ai

    SSLEngine on
    SSLCertificateFile /etc/ssl/openstack/openstack.crt
    SSLCertificateKeyFile /etc/ssl/openstack/openstack.key

    WSGIDaemonProcess glance-api user=glance group=glance processes=4 threads=1 display-name=%{GROUP}
    WSGIProcessGroup glance-api
    WSGIScriptAlias / /usr/bin/glance-wsgi-api
    WSGIPassAuthorization On
    LimitRequestBody 0

    <Directory /usr/bin>
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/glance_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/glance_ssl_access.log combined
</VirtualHost>
EOF
```
```shell
a2ensite glance-https
systemctl restart apache2
systemctl reload apache2
```

