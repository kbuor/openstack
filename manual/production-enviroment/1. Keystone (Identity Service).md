# Run on Controlelr
## Prerequisites
---
### Prepare SQL Databases
```shell
mysql
```
```shell
CREATE DATABASE keystone;
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'localhost' IDENTIFIED BY 'OpenStack';
GRANT ALL PRIVILEGES ON keystone.* TO 'keystone'@'%' IDENTIFIED BY 'OpenStack';
EXIT;
```
## Install and configure components
---
### Install package
```shell
apt install -y keystone python3-openstackclient
```
### Configure Keystone
```shell
cat <<'EOF' > /etc/keystone/keystone.conf
[DEFAULT]
log_dir = /var/log/keystone
[application_credential]
[assignment]
[auth]
[cache]
[catalog]
[cors]
[credential]
[database]
connection = mysql+pymysql://keystone:OpenStack@controller01.openstack.local/keystone
[domain_config]
[endpoint_filter]
[endpoint_policy]
[extra_headers]
Distribution = Ubuntu
[federation]
[fernet_receipts]
[fernet_tokens]
[healthcheck]
[identity]
[identity_mapping]
[jwt_tokens]
[ldap]
[oauth1]
[oauth2]
[oslo_messaging_amqp]
[oslo_messaging_kafka]
[oslo_messaging_notifications]
[oslo_messaging_rabbit]
[oslo_middleware]
[oslo_policy]
[policy]
[profiler]
[receipt]
[resource]
[revoke]
[role]
[saml]
[security_compliance]
[shadow_users]
[token]
provider = fernet
[tokenless_auth]
[totp]
[trust]
[unified_limit]
[wsgi]
EOF
```
### Populate the Identity service database
```shell
su -s /bin/sh -c "keystone-manage db_sync" keystone
```
### Initialize Fernet key repositories
```shell
keystone-manage fernet_setup --keystone-user keystone --keystone-group keystone
keystone-manage credential_setup --keystone-user keystone --keystone-group keystone
```
### Bootstrap the Identity service
```shell
keystone-manage bootstrap \
--bootstrap-password OpenStack \
--bootstrap-admin-url https://keystone.kbuor.io.vn:5000/v3/ \
--bootstrap-internal-url https://keystone.kbuor.io.vn:5000/v3/ \
--bootstrap-public-url https://keystone.kbuor.io.vn:5000/v3/ \
--bootstrap-region-id RegionOne
```
## Configure the Apache HTTP server
---
```shell
a2dissite keystone
rm -rf /etc/apache2/sites-available/keystone.conf
```
```shell
cat <<'EOF' > /etc/apache2/sites-available/keystone-https.conf
<VirtualHost *:5000>
    ServerName keystone.kbuor.io.vn

    SSLEngine on
    SSLCertificateFile /etc/ssl/openstack/openstack.crt
    SSLCertificateKeyFile /etc/ssl/openstack/openstack.key

    WSGIDaemonProcess keystone-public user=keystone group=keystone processes=5 threads=1 display-name=%{GROUP}
    WSGIProcessGroup keystone-public
    WSGIScriptAlias / /usr/bin/keystone-wsgi-public

    <Directory /usr/bin>
        Require all granted
    </Directory>

    ErrorLog ${APACHE_LOG_DIR}/keystone_ssl_error.log
    CustomLog ${APACHE_LOG_DIR}/keystone_ssl_access.log combined
</VirtualHost>
EOF
echo "Listen 5000" >> /etc/apache2/ports.conf
```
```shell
a2enmod ssl
a2ensite keystone-https
systemctl restart apache2
systemctl reload apache2
```
## Create Credentials File
---
```shell
cat <<'EOF' > /root/admin-openrc
export OS_USERNAME=admin
export OS_PASSWORD=OpenStack
export OS_PROJECT_NAME=admin
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_DOMAIN_NAME=Default
export OS_AUTH_URL=https://keystone.kbuor.io.vn:5000/v3
export OS_IDENTITY_API_VERSION=3
EOF
source /root/admin-openrc
```
## Create Service Project of Default Domain for Service Account
---
```shell
openstack project create --domain default --description "Service Project" service
```
